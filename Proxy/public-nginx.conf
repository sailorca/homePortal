# HTTP context

# Token validation map
map $arg_token $auth_status {
    include /etc/nginx/demo-configs/tokens.conf;
    default "denied";
}

# Cookie token validation - check cookie token against same token list
map $cookie_demo_token $cookie_auth_status {
    include /etc/nginx/demo-configs/tokens.conf;
    default "denied";
}

# Dynamic subdomain to port mapping
map $host $upstream_port {
    include /etc/nginx/demo-configs/subdomain-ports.conf;
    default "8000";
}

# Smart WebSocket connection handling
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# HTTP redirect to HTTPS
server {
    listen 80;
    server_name *.demo.anchoredtechnologies.net demo.anchoredtechnologies.net;
    return 301 https://$host$request_uri;
}

# Main HTTPS server
server {
    listen 443 ssl;
    http2 on;
    server_name *.demo.anchoredtechnologies.net demo.anchoredtechnologies.net;
    
    # SSL configuration
    ssl_certificate /etc/letsencrypt/live/demo.anchoredtechnologies.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/demo.anchoredtechnologies.net/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    set $auth_ok "no";
    set $set_cookie "";

    # Check for valid cookie token        
    if ($cookie_auth_status = "allowed") {
        set $auth_ok "yes";
    }
        
    # Check for valid URL token  
    if ($auth_status = "allowed") {
        set $auth_ok "yes";
        set $set_cookie "demo_token=$arg_token; Domain=$host; Path=/; Secure; HttpOnly; Max-Age=2592000";
    }

    # Debug headers - always added
    add_header X-Debug-Auth-Successful $auth_ok always;
    add_header X-Debug-Token-From-URL "$arg_token" always;
    add_header X-Debug-Cookie-From-Browser "$cookie_demo_token" always;
    add_header X-Debug-Cookie-Auth-Status "$cookie_auth_status" always;
    add_header X-Debug-URL-Auth-Status "$auth_status" always;        

    # If no valid auth, deny
    if ($auth_ok = "no") {
        return 403 "Access denied. Use: https://$host/?token=your-token";
    }
    
    # set_cookie may have no value which sucks but there is no easy solution
    add_header Set-Cookie $set_cookie always;

    location / {
        # Proxy to backend
        proxy_pass http://127.0.0.1:$upstream_port;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}